#!/bin/bash

# Deploy the Folio SvelteKit application to a local Docker container.

usage() {
    echo "Usage: $0 [--namespace <github-namespace>]"
    echo "Options:"
    echo "  --namespace     Specify the GitHub namespace for the Docker image"
    echo "Environment variables:"
    echo "  GITHUB_NAMESPACE    GitHub namespace for the Docker image."
}

while $1; do
    case "$1" in
        --namespace) GITHUB_NAMESPACE="$2"; shift;;
        *) echo "Unknown option: $1"; exit 1;;
    esac
    shift
done

if docker image inspect folio:latest > /dev/null 2>&1; then
    docker run -d \
        --name folio \
        -p 3000:3000 \
        folio:latest
else
    echo "Docker image 'folio:latest' not found."
    echo "Pulling the latest image from GitHub Container Registry..."
    if [ -z "$GITHUB_NAMESPACE" ]; then
        echo "Error: GitHub namespace is required to retrieve image."
        usage
        exit 1
    fi
    docker pull ghcr.io/$GITHUB_NAMESPACE/folio:latest
    if [ $? -ne 0 ]; then
        echo "Failed to pull Docker image from GitHub Container Registry."
        echo "Build the image locally with 'containerize' script."
        exit 1
    fi
    docker run -d \
        --name folio \
        -p 3000:3000 \
        ghcr.io/$GITHUB_NAMESPACE/folio:latest
fi
if [ $? -ne 0 ]; then
    echo "Failed to start the Folio application."
    exit 1
fi
echo "Folio application is running on http://localhost:3000"
